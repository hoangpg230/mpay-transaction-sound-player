function loadScriptAsync(e){return new Promise((t,o)=>{let a=document.createElement("script");a.type="text/javascript",a.src=e,a.onload=()=>t(`Loaded: ${e}`),a.onerror=()=>o(`Failed: ${e}`),document.head.appendChild(a)})}window.addEventListener("DOMContentLoaded",async()=>{try{function e(){let e=document.querySelector(".mpay-transaction-sound-player");return e?{host:e.dataset.host,port:e.dataset.port,username:e.dataset.username,password:e.dataset.password}:(console.error("MQTT settings element not found!"),null)}let t=e();if(!t.host||!t.host||!t.username||!t.password){console.log("Please provide necessary info to connect...");return}await loadScriptAsync("https://unpkg.com/vue@3/dist/vue.global.js"),await loadScriptAsync("https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.10.3/mqtt.min.js");let{ref:o,watch:a,onMounted:n,onUnmounted:r,nextTick:s}=Vue,i=new Map,l=["0h","0","01","02","03","04","05","06","07","08","09","100","200","300","400","500","600","700","800","900","b","h","m","r","t","on","off","$",],u=[...Array(100).fill("").map((e,t)=>(t+1).toString()),...l,];for(let c of u)i.set(c.toString(),`https://mms.msb.com.vn/audios/${c}.mp3`);let d={host:t.host,port:t.port,protocol:"wss",endpoint:"/mqtt",clean:!0,connectTimeout:1e4,reconnectPeriod:1e4,clientId:"mqtt_wss_client_"+Math.random().toString(16).substr(2,8),username:t.username,password:t.password,rejectUnauthorized:!0};function p(){let e="MPAY/MMS/root_topic";try{let t=JSON.parse(localStorage.getItem("MASTER_MERCHANT")||'""'),o=JSON.parse(localStorage.getItem("MASTER_TERMINAL")||'""');t&&o&&(e=`MPAY/MMS/${t}_${o}`)}catch(a){console.log(a),e="MPAY/MMS/root_topic"}return e}function $(){let e=o(),t=[],l=new(window.AudioContext||window.webkitAudioContext),u=o("MPAY/MMS/root_topic"),c=o(""),$=o(!1),v=o({properties:{contentType:"application/json"},qos:0}),m=o(!1),g=o([]),{protocol:f,host:h,port:b,endpoint:w,...M}=d,S=`${f}://${h}:${b}${w}`,y=mqtt.connect(S,M);function A(e){e?u.value=e:u.value=p();let{topic:t,qos:o}={...v.value,topic:e||p()};y&&y.subscribe(t,{qos:o},(e,t)=>{if(e){console.log("Subscribe to topics error",e);return}m.value=!0,console.log("Subscribe to topics res",t)})}function _(e){return new Promise(async t=>{await s();let o=e.split("-"),a=0;!function e(){if(a<o.length)try{navigator.mediaDevices.getUserMedia({audio:!0}).then(()=>{let t=l.createGain();t.gain.value=1;let n=l.createBufferSource();n.addEventListener("ended",()=>{n.stop(),a++,e()});let r=new XMLHttpRequest;r.open("GET",i.get(o[a]),!0),r.responseType="arraybuffer",r.onload=()=>{l.decodeAudioData(r.response,e=>{n.buffer=e,n.connect(l.destination),n.start()},t=>{console.log("Error decoding audio data:",t.message),a++,e()})},r.send()}).catch(()=>{let t=new Audio(i.get(o[a]));t.play(),t.onended=()=>{a++,e()},t.onerror=()=>{console.error(`Failed to load: ${i.get(o[a])}`),a++,e()}})}catch{console.error("Device does not support audio")}else t()}()})}return y.on("connect",()=>{A()}),y.on("message",(e,o)=>{console.log("Received message:",JSON.parse(o.toString()).tranAmount),c.value=JSON.parse(o.toString()).data,t.push(c.value)}),a(g,async()=>{if(await s(),!$.value&&g.value.length>0){for($.value=!0;g.value.length>0;){let e=g.value.shift();e&&await _(e),await s()}$.value=!1}},{deep:!0,immediate:!0}),n(()=>{e.value=setInterval(()=>{t?.length&&(g.value=[...g.value,...t],t=[])},200)}),r(()=>{e.value&&clearInterval(e.value)}),{playSound:_,doSubscribe:A,doUnSubscribe:function e(t){t?u.value=t:u.value=p();let{topic:o}={...v.value,topic:u.value};y?.unsubscribe(o,e=>{if(e){console.log("Unsubscribe error",e);return}console.log("Unsubscribed topic: ",o),m.value=!1})},resetMessageQueue(){g.value=[]},setMessageQueue(e){g.value=[],g.value.push(e)}}}let v=Vue.createApp({setup(){window.mqttInstance=$(),document.dispatchEvent(new Event("mqttReady"))}});v.mount("body")}catch(m){console.error(m)}});