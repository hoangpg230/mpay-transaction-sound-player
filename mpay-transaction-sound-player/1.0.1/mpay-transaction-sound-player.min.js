function loadScriptAsync(e){return new Promise((t,o)=>{let n=document.createElement("script");n.type="text/javascript",n.src=e,n.onload=()=>t(`Loaded: ${e}`),n.onerror=()=>o(`Failed: ${e}`),document.head.appendChild(n)})}window.addEventListener("DOMContentLoaded",async()=>{try{let e=document.createElement("div");e.id="vue-container",document.body.appendChild(e),await loadScriptAsync("https://unpkg.com/vue@3/dist/vue.global.js"),await loadScriptAsync("https://cdnjs.cloudflare.com/ajax/libs/mqtt/5.10.3/mqtt.min.js");let{ref:t,watch:o,onMounted:n,onUnmounted:a,nextTick:r}=Vue,i=new Map,s=["0h","0","01","02","03","04","05","06","07","08","09","100","200","300","400","500","600","700","800","900","b","h","m","r","t","on","off","$",],c=[...Array(100).fill("").map((e,t)=>(t+1).toString()),...s,];for(let u of c)i.set(u.toString(),`https://mms.msb.com.vn/audios/${u}.mp3`);let l=(e,t,o,n)=>({host:e,port:t,protocol:"wss",endpoint:"/mqtt",clean:!0,connectTimeout:1e4,reconnectPeriod:1e4,clientId:"mqtt_wss_client_"+Math.random().toString(16).substr(2,8),username:o,password:n,rejectUnauthorized:!0});function d(){let e="MPAY/MMS/root_topic";try{let t=JSON.parse(localStorage.getItem("MASTER_MERCHANT")||'""'),o=JSON.parse(localStorage.getItem("MASTER_TERMINAL")||'""');t&&o&&(e=`MPAY/MMS/${t}_${o}`)}catch(n){console.log(n),e="MPAY/MMS/root_topic"}return e}function p(e,s,c,u){let p;if(!e||!s||!c||!u){console.log("Please provide the necessary info to connect...");return}let $=t(),v=[],m=new(window.AudioContext||window.webkitAudioContext),g=t("MPAY/MMS/root_topic"),f=t(""),h=t(!1),b=t({properties:{contentType:"application/json"},qos:0}),y=t(!1),M=t([]),{protocol:w,host:S,port:A,endpoint:_,...E}=l(e,s,c,u),T=`${w}://${S}:${A}${_}`,q=mqtt.connect(T,E);function P(e){e?g.value=e:g.value=d();let{topic:t,qos:o}={...b.value,topic:e||d()};q&&q.subscribe(t,{qos:o},(e,t)=>{if(e){console.log("Subscribe to topics error",e);return}y.value=!0,console.log("Subscribe to topics res",t)})}function j(e){return new Promise(async t=>{await r();let o=e.split("-"),n=0;!function e(){if(n<o.length)try{navigator.mediaDevices.getUserMedia({audio:!0}).then(()=>{m.createGain().gain.value=1;let t=m.createBufferSource();t.addEventListener("ended",()=>{t.stop(),n++,e()});let a=new XMLHttpRequest;a.open("GET",i.get(o[n]),!0),a.responseType="arraybuffer",a.onload=()=>{m.decodeAudioData(a.response,e=>{t.buffer=e,t.connect(m.destination),t.start()},t=>{console.log("Error decoding audio data:",t.message),n++,e()})},a.send()}).catch(()=>{let t=new Audio(i.get(o[n]));t.play(),t.onended=()=>{n++,e()},t.onerror=()=>{console.error(`Failed to load: ${i.get(o[n])}`),n++,e()}})}catch{console.error("Device does not support audio")}else t()}()})}return q.on("connect",()=>{P()}),q.on("message",(e,t)=>{f.value=JSON.parse(t.toString()).data,v.push(f.value),"function"==typeof p&&p(f.value)}),o(M,async()=>{if(await r(),!h.value&&M.value.length>0){for(h.value=!0;M.value.length>0;){let e=M.value.shift();e&&await j(e),await r()}h.value=!1}},{deep:!0,immediate:!0}),n(()=>{$.value=setInterval(()=>{v?.length&&(M.value=[...M.value,...v],v=[])},200)}),a(()=>{$.value&&clearInterval($.value)}),{doSubscribe:P,doUnSubscribe:function e(t){t?g.value=t:g.value=d();let{topic:o}={...b.value,topic:g.value};q?.unsubscribe(o,e=>{if(e){console.log("Unsubscribe error",e);return}console.log("Unsubscribed topic: ",o),y.value=!1})},resetMessageQueue(){M.value=[]},setMessageQueue(e){M.value=[],M.value.push(e)},onReceiveMessage(e){p=e},async isAudioPermissionGranted(){try{let e=await navigator.permissions.query({name:"microphone"});return"granted"===e.state}catch(t){return!1}},async requestAudioDevice(){let e=!1;try{await navigator.mediaDevices.getUserMedia({audio:!0}),e=!0}finally{return e}}}}Vue.createApp({setup(){window.Init=p,document.dispatchEvent(new Event("MPAYTransSoundPlayerLoaded"))}}).mount("#vue-container")}catch($){console.error($)}});